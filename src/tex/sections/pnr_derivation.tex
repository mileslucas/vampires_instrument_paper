\section{Photon number resolving statistics}\label{sec:pnr_derivation}

We derive the theoretical noise effects of photon-number resolving data \textit{post-hoc}, wherein data that is assumed to be perfectly bias-subtracted and flat-corrected is converted to electron flux using the detector gain and rounded to the nearest whole number.

Photons which enter the detector have a certain probability of becoming photo-electrons (hereafter electrons) described by the quantum efficiency. We ignore this for now and describe our input flux in electrons. These electrons are subject to counting statistics due to their Poisson nature. Let $H$ be the rate of electrons per pixel (the quanta exposure). The probability of measuring a signal of $k$ electrons is then
\begin{equation}
    \mathcal{P}\left(k | H\right) = \frac{H^k e^{-H}}{k!}
\end{equation}

Now consider the Gaussian read noise, $\sigma_{RN}$
\begin{equation}
    \mathcal{N}\left(x | k, \sigma_RN\right) = \frac{1}{\sigma_{RN}\sqrt{2\pi}}e^{-(x - k)^2 / 2\sigma_{RN}^2}
\end{equation}
The probability of measuring $U$ electrons after both processes is the convolution of the two distributions
\begin{equation}
    P(U | H, \sigma_{RN}) = \sum_{k=0}^\infty{\mathcal{N}\left(U | k, \sigma_{RN}\right)\cdot \mathcal{P}\left(k|H\right)}
\end{equation}

Qualitatively, we recognize that this can be described as discrete Poisson peaks which get widened by a Gaussian of width $\sigma_{RN}$. Consider the simple case of $H=0$, the data is simply a Gaussian centered at zero. If we take this data and round it to the nearest whole number, there is a small chance for values $|U|>0.5$  to get rounded to -1 and 1, respectively, or for $|U| > 1.5$ to -2 and 2, and so on, causing variance in the measured photon number. 

We create a new distribution which is described as the probability of measuring values which will be rounded to the correct bins, $h(k)$

\begin{align}
    h(k) = &P\left(|U - k| < 0.5 | \sigma_{RN}\right) \\
    &= \int_{k - 0.5}^{k + 0.5}{\mathcal{N}(x | k, \sigma_{RN}) dx}
\end{align}

This can be rewritten using the cumulative distribution of the unit normal, $\Phi$, 
\begin{equation}
    h(k) = \Phi\left(\frac{k + 0.5}{\sigma_{RN}} \right) - \Phi\left(\frac{k - 0.5}{\sigma_{RN}} \right)
\end{equation}
with
\begin{equation}
    \Phi(z) = \frac12 \left[1 - \mathrm{erf}\left(\frac{z}{\sqrt{2}}\right) \right]
\end{equation}
and where $\mathrm{erf}$ is the error function.

The expected value of this distribution is 0 by convenience of symmetry
\begin{equation}
    \mathrm{E}[h] = \sum_{k=-\infty}^{\infty}{ k \cdot h(k)} = 0
\end{equation}

The variance of this distribution is
\begin{equation}
\label{eqn:pnr_var}
    \mathrm{Var}[h] = \sum_{k=-\infty}^{\infty}{ k^2\cdot h(k)}
\end{equation}
Therefore the total noise from photon number resolving is the combination of photon noise and \autoref{eqn:pnr_var}.
\begin{equation}
    \label{eqn:pnr_std}
    \sigma = \sqrt{U + \sum_{k=-\infty}^{\infty}{ k^2\cdot \left[\Phi\left(\frac{k + 0.5}{\sigma_{RN}} \right) - \Phi\left(\frac{k - 0.5}{\sigma_{RN}}\right)\right]}}
\end{equation}
For practical applications we truncate $k$ to \num{\pm5} since the probability of observing a Gaussian event over 5 standard deviations away is extremely small,  below $10^{-5}$.
